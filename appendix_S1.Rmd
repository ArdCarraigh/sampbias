---
title: "sampbias, a method for quantifying geographic sampling biases in species distribution data"
subtitle: "Appendix S1 - Supplementary Figure"
author: "Alexander Zizka, Alexandre Antonelli, Daniele Silvestro"
output: rmarkdown::pdf_document
header-includes: |
    \usepackage{float}
    \renewcommand{\thefigure}{S\arabic{figure}}
---

\newpage{}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r, fig.height = 8, fig.cap="The example dataset of mammal occurrences from the island of Borneo, as downloaded from www.gbif.org (n = 6,262, 2016, https://doi.org/10.15468/dl.7fg4zx), and the geographic gazetters of main cities, roads, rivers and airports used for the sampbias analysis. Note that the records in the sea around Borneo were excluded by with the help of the user-provided study area."}
#libraries
library(raster)
library(ggplot2)
library(magrittr)
library(sp)
library(dplyr)
library(viridis)
library(readr)
library(sf)
library(geosphere)
library(tidyr)
library(forcats)

## get a polygon of Borneo
data(landmass)

born2 <- st_read("empirical_analyses/Borneo.kml", quiet = TRUE)
born2 <- sf:::st_zm(born2$geom)
born2 <- as(born2, 'Spatial')


#load data
occ <-read.csv(system.file("extdata", "mammals_borneo.csv", package="sampbias"), sep = "\t") %>% 
  dplyr::select(latitude = decimalLatitude, longitude = decimalLongitude) %>% 
  mutate(type = "Mammal occurrence")

data(airports)
data(waterbodies)
data(cities)
data(roads)
data(landmass)

# prepare for plotting
airp <- airports %>% crop(SpatialPoints(occ[,2:1])) %>% raster::intersect(born2) %>%  coordinates() %>%  data.frame() %>% mutate(type = "Airport")
cit <- cities %>% crop(SpatialPoints(occ[,2:1])) %>% raster::intersect(born2) %>%  coordinates() %>%  data.frame() %>%  mutate(type = "City")
pts <- bind_rows(occ, cit, airp)


riv <- waterbodies %>% crop(SpatialPoints(occ[,2:1])) %>%  fortify() %>%  mutate(type = "River")
road <- roads %>% crop(SpatialPoints(occ[,2:1])) %>% raster::intersect(born2) %>%  fortify() %>%  mutate(type = "Road")
lin <- bind_rows(riv, road)


lma <- landmass %>% crop(SpatialPoints(occ[,2:1])) %>% raster::intersect(born2) %>%  fortify()

# plot
ggplot()+
  geom_polygon(data = lma,
               mapping = aes(x = long, y = lat, group = group), lwd = 0.5, col = "grey40", fill = "transparent")+
  geom_path(mapping = aes(x = long, y = .data$lat, group = .data$group, shape = type, color = type),
            data = lin)+
  geom_point(data = pts, mapping = aes(x = longitude, y = latitude, linetype = type, color = type), size = 3)+
  scale_color_viridis(discrete = TRUE)+
  xlab("Longitude")+
  ylab("Latitude")+
  coord_fixed()+
  theme_bw()+
  theme(
    legend.position = "bottom"
  )
```




```{r}
occ <-read.csv(system.file("extdata", "mammals_borneo.csv", package="sampbias"), sep = "\t")

data(landmass)

born <- raster::intersect(landmass, born2)

area <- round(areaPolygon(born) / 1000000, 0)

REWRITE THIS PART TO DEAL WITH THE NEW TYPE OF OUTPUT FILES

dat <- read_csv("empirical_analyses/simulations/weight_estimates.csv") %>% 
  mutate(records_area = round(rar / area * 10000, 2)) %>% 
  select(contains("w"), ID, type, records_area) %>% 
  select(-w_rate) %>% 
    pivot_longer(cols = contains("w_"), names_to = "bias",
                 values_to = "posterior_estimate") %>%
    mutate(bias = gsub("w_", "", .data$bias))
```


```{r, echo = FALSE, fig.cap="The bias weights ($w$) quantifying the effects of each bias factor estimated from data sets with differing density of occurrence records across the study area. Datasets generated by down-sampling the empirical example dataset of mammal occurrences on Borneo (www.gbif.org,  2016, https://doi.org/10.15468/dl.7fg4zx)."}
plo <- dat %>%  filter(type == "empirical") %>%
    mutate(bias = fct_reorder(.data$bias, .data$posterior_estimate, .fun = median, .desc = FALSE))
# ggplot(data = plo)+
#   geom_point(aes(x = bias, 
#                  y = posterior_estimate, 
#                  group = as.factor(records_area), 
#                  color = as.factor(ID)), 
#              position = position_jitterdodge())+
#   xlab("Posterior weight")+
#   xlab("Bias factor")+
#   scale_color_viridis(discrete = TRUE)+
#   theme_bw()

ggplot(data = plo)+
  geom_boxplot(aes(x = bias, 
                   y = posterior_estimate,
                 fill = as.factor(records_area),
                 color = as.factor(records_area)))+
  ylab("Posterior weight")+
  xlab("Bias factor")+
  scale_fill_viridis(discrete = TRUE, name = "Records per\n10,000 sqkm")+
  scale_color_viridis(discrete = TRUE, name = "Records per\n10,000 sqkm")+
  theme_bw()
```


```{r, out.width = "6in", fig.cap = "Projected bias surface for the distribution data of mammals from Borneo (www.gbif.org, 2016, https://doi.org/10.15468/dl.7fg4zx), at different levels of downsampling, from a random replicate. The plotted extent is adapted to the study area, which may not cover the entire island for rarified datasets with few records (A) and B))"}

REDO WITH THE NEW RESULTS

knitr::include_graphics(path = "ms_figures/figure_projection_empirical_rarefaction.jpg")

```



```{r, echo = FALSE, fig.cap="The bias weights ($w$) defining the effects of each bias factor estimated from data sets with differing density of occurrence records across the study area. Datasets generated by random simulation of records across Borneo (no bias)."}

Here a boxplot comparing the results form the empirical analyses with the ones fromt he randomly simulated analyses

plo <- dat %>%  filter(type == "simulated") %>%
    mutate(bias = fct_reorder(.data$bias, .data$posterior_estimate, .fun = median, .desc = FALSE))

ggplot(data = plo)+
  geom_boxplot(aes(x = bias, 
                   y = posterior_estimate,
                   fill = as.factor(records_area),
                   color = as.factor(records_area)))+
  ylab("Posterior weight")+
  xlab("Bias factor")+
  scale_fill_viridis(discrete = TRUE, name = "Records per\n10,000 sqkm")+
  scale_color_viridis(discrete = TRUE, name = "Records per\n10,000 sqkm")+
  theme_bw()
```


```{r, echo = FALSE, fig.height = 8, fig.cap="The bias weights ($w$) defining the effects of each bias factor estimated for the smallest simulated dataset without bias."}

Here a histogram of the weight estimates

ggplot(data = plo)+
  geom_histogram(aes(posterior_estimate, fill = as.factor(records_area)), bins = 50) +
  scale_fill_viridis(discrete = TRUE, name = "Records per\n10,000 sqkm")+
  facet_grid(rows = vars(records_area), cols = vars(bias))+
  scale_x_continuous(breaks = c(0,0.003, 0.006, 0.009), limits = c(0,0.01))+
  xlab("Posterior weight")+
  ylab("Count")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(),
        legend.position = "none")

```

