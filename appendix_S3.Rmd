---
title: "Appendix S3 - The effect of dataset size on parameter estimates"
subtitle: "Sampbias, a method to evaluate geographic sampling bias in species distribution data"
author: "Alexander Zizka, Alexandre Antonelli, Daniele Silvestro"
output: rmarkdown::pdf_document
header-includes: |
    \usepackage{float}
    \renewcommand{\thefigure}{S3.\arabic{figure}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

library(readr)
library(ggplot2)
library(magrittr)
library(sf)
library(geosphere)
library(dplyr)
library(tidyr)
library(forcats)
library(viridis)

```


The density of records might affect to estimate the sampling rate and bias weights (i.e. "How many records are needed to get reliable estimates?". To test the sensitivity of sampbias to the number of records in the input dataset, we ran two simulation studies:

1) As an example for a biased data set, we used the empirical example dataset with occurrence records of mammals from the island of Borneo. We down sampled the records by the factors 0.5, 0.25, 0.1, 0.01, 0.001 times the original number of records (i.e. 3131, 1566, 626, 62, and 6 records for all of Borneo) and ran a separate sampbias analyses on each of these down sampled datasets and compared the estimated posterior weights for each biasing factor. We replicated this analyses 5 times (A total of 25 analyses). The estimates of the bias weights were similar across analyses, suggesting that sampbias can robustly quantify sampling bias even with low record densities (Fig. 1).

2) We simulated seven data sets with 100,000, 50,000, 10,000, 1,000, 100, and 10 records randomly distributed across Borneo (no accessibility bias) and ran a separate sampbias analyses for each of these data sets, and replicated the analyses five times (a total of 35 analyses). The estimates of the bias weights were similar across analyses, suggesting that sampbias is robust against false positives in bias detection even in datasets with low record density (Fig. 2).

```{r}
occ <-read.csv(system.file("extdata", "mammals_borneo.csv", package="sampbias"), sep = "\t")

data(landmass)

born2 <- st_read("empirical_analyses/Borneo.kml", quiet = TRUE)
born2 <- sf:::st_zm(born2$geom)
born2 <- as(born2, 'Spatial')
born <- raster::intersect(landmass, born2)

area <- round(areaPolygon(born) / 1000000, 0)


dat <- read_csv("empirical_analyses/simulations/weight_estimates.csv") %>% 
  mutate(records = rar * nrow(occ)) %>% 
  mutate(records_area = round(records / area * 10000, 2)) %>% 
  select(contains("w"), ID, type, records_area) %>% 
    pivot_longer(cols = contains("w_"), names_to = "bias",
                 values_to = "posterior_estimate") %>%
    mutate(bias = gsub("w_", "", .data$bias)) %>%
    mutate(bias = fct_reorder(.data$bias, .data$posterior_estimate, .fun = median, .desc = FALSE))
```


```{r, echo = FALSE, fig.cap="The bias weights ($w$) defining the effects of each bias factor estimated from data sets with differing density of occurrence records across the study area. Datasets generated by down sampling the empirical example dataset of mammal occurrences on Borneo."}
plo <- dat %>%  filter(type == "empirical")
# ggplot(data = plo)+
#   geom_point(aes(x = bias, 
#                  y = posterior_estimate, 
#                  group = as.factor(records_area), 
#                  color = as.factor(ID)), 
#              position = position_jitterdodge())+
#   xlab("Posterior weight")+
#   xlab("Bias factor")+
#   scale_color_viridis(discrete = TRUE)+
#   theme_bw()

ggplot(data = plo)+
  geom_boxplot(aes(x = bias, 
                   y = posterior_estimate,
                 fill = as.factor(records_area)))+
  ylab("Posterior weight")+
  xlab("Bias factor")+
  scale_fill_viridis(discrete = TRUE, name = "Records per\n10,000 sqkm")+
  theme_bw()
```


```{r, echo = FALSE, fig.cap="The bias weights ($w$) defining the effects of each bias factor estimated from data sets with differing density of occurrence records across the study area. Datasets generated by random simulation of records across Borneo (no bias)."}
plo <- dat %>%  filter(type == "simulated")

ggplot(data = plo)+
  geom_boxplot(aes(x = bias, 
                   y = posterior_estimate,
                 fill = as.factor(records_area)))+
  ylab("Posterior weight")+
  xlab("Bias factor")+
  scale_fill_viridis(discrete = TRUE, name = "Records per\n10,000 sqkm")+
  theme_bw()
```
